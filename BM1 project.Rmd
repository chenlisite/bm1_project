---
title: "BM1 project"
author: "Chen Li"
date: "December 10, 2017"
output: html_document
---

```{r setup, echo = FALSE, message = FALSE, results = FALSE, warning = FALSE}


knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%")
library(readxl)
library(tidyverse)
library(janitor)
library(faraway)
library(broom)
library(dplyr)
library(haven)
library(rvest)
library(stringr)
library(forcats)
#create fxn for full library load
#watch jg lecture videos for this hw


```


```{r clean dataset}
patientdata = read_excel("GHProject_Dataset.xlsx") %>% 
  clean_names()%>%
  separate(admitdtm, into = c("week", "month","year"), sep = ",")%>%
  mutate(
         day = str_sub(month,-3,-1),
       month = str_sub(month, 1, -4))%>%
  mutate(month= as.numeric(factor(substr(month,2,4), levels = month.abb)))%>%
  arrange(by=patientid,year,month, day)%>%
  distinct(patientid, .keep_all = TRUE) %>% 
  rename(
    age = ageyear, 
    marital_status = maritalstatus, 
    insurance_type = insurancetype,
    facility = facilityname, 
    facility_zip = facilityzip,
    postal_code = postalcode,
    los_hours = loshours, 
    los_days = losdays2,
    o2_sat = o2sat,
    respiration_rate = respirationrate, 
    heart_rate = heartrate, 
    bp_systolic = bpsystolic, 
    bp_diastolic = bpdiastolic, 
    patient_id = patientid, 
    visit_id = visitid) %>% 
  mutate(
    los_days = round(los_days, 2),
    temperature = round(temperature, 2),
    bmi = round(bmi, 2),
    respiration_rate = round(respiration_rate, 2),
    o2_sat = round(o2_sat, 2),
    heart_rate = round(heart_rate, 2), 
    bp_systolic = round(bp_systolic, 2), 
    bp_diastolic = round(bp_diastolic, 2))

patientdata %>% 
  count(race)
```
  
  
```{r factor recoding}
# cindex: 0=normal,1-2=mild,3-4=moderate,>5=severe
patientdata= patientdata %>%
mutate( cindex = factor(cindex),
        cindex = fct_recode(cindex, 
                         "normal" = "0",
                         "mild" = "1",
                         "mild" = "2",
                         "moderate"= "3",
                         "moderate"= "4",
                         "severe"="5"))

# gender: 0="Female",1="Male"
patientdata$gender<-ifelse(patientdata$gender == "Male",1,0)


#insurance type: 0="Medicaid", 2 = "Medicare", 3="Private"
patientdata= patientdata %>%
mutate(insurance_type = factor(insurance_type),
       insurance_type = fct_recode(insurance_type, 
                         "0" = "Medicaid",
                         "1"="Medicare",       
                         "2"="Private"))

# marital status: 0="married or living as married", 1="widowed or seperated", 2="unmarried"
patientdata= patientdata %>%
mutate( marital_status = factor(marital_status),
        marital_status = fct_recode(marital_status, 
                         "0" = "Married",
                         "0"= "Civil Union",
                         "1"= "Widowed",
                         "1" = "Separated",
                         "2"= "Single" ,
                         "2"= "Divorced"))

# mews: 0-1=normal(0), 2-3=increase caution(1), 4-5=further deterioration(2), >5 immediate action required(3)
patientdata=patientdata %>% 
mutate(mews=ifelse(mews >5,3,ifelse(mews >=4,2, ifelse(mews >=2, 1,0))))

# race
patientdata = patientdata %>%
  mutate(race = fct_recode(race, 
                         "0" = "White",
                         "1" = "African Amer/Black",       
                         "2" = "Asian",
                         "3" = "Other/Multiracial",
                         "4" = "Native Amer/Alaskan",
                         "5" = "Natv Hawaii/Pacf Isl"))


```



```{r}
patientdata = patientdata %>% 
  mutate(log_los = log(los_hours))
hist(patientdata$log_los)
```

```{r}
# interested variables
data_fit = patientdata %>%
select(log_los,mews,is30dayreadmit,cindex,evisit,age,race,icu_flag,gender,marital_status,insurance_type,bmi,bp_systolic,o2_sat, temperature,heart_rate,respiration_rate)
```

```{r}
# stepwise???
data_fit=na.omit(data_fit)
mult.fit <- lm(log_los ~ ., na.action=na.exclude, data=data_fit)
step(mult.fit, direction='backward')
```

```{r}
# MLR - big model
mult.fit_1 <- lm(log_los ~ factor(is30dayreadmit) + factor(cindex) + evisit + age + factor(gender) + factor(marital_status) + factor(insurance_type) + bp_systolic + o2_sat + heart_rate +  respiration_rate, data=data_fit)
summary (mult.fit_1)
anova(mult.fit_1)
```

```{r}
mult.fit_2 <- lm(log_los ~ factor(is30dayreadmit) + factor(cindex) + evisit + age + factor(marital_status) + factor(insurance_type) + bp_systolic + heart_rate +  respiration_rate,data=data_fit)
anova(mult.fit_2,mult.fit_1)
#choose mult.fit_2
```


